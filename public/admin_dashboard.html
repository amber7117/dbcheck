<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/antd/dist/antd.min.css">
    <script src="https://unpkg.com/react/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://unpkg.com/antd/dist/antd.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { Table, Input, Button, Card, message, Form, Modal } = antd;
        const { useState, useEffect } = React;

        const App = () => {
            const [users, setUsers] = useState([]);
            const [developers, setDevelopers] = useState([]);
            const [filteredUsers, setFilteredUsers] = useState([]);
            const [userForm] = Form.useForm();
            const [devForm] = Form.useForm();

            useEffect(() => {
                fetchUsers();
                fetchDevelopers();
            }, []);

            const fetchUsers = async () => {
                const response = await fetch('/admin/users');
                const data = await response.json();
                setUsers(data);
                setFilteredUsers(data);
            };

            const fetchDevelopers = async () => {
                const response = await fetch('/admin/developers');
                const data = await response.json();
                setDevelopers(data);
            };

            const handleUserSearch = (e) => {
                const value = e.target.value.toLowerCase();
                const filtered = users.filter(user => user.userId.toString().includes(value));
                setFilteredUsers(filtered);
            };

            const handleUpdatePoints = async (userId, points) => {
                await fetch(`/admin/user/${userId}/points`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ points: parseInt(points) })
                });
                message.success('Points updated');
            };

            const handleDeleteUser = (userId) => {
                Modal.confirm({
                    title: 'Are you sure you want to delete this user?',
                    onOk: async () => {
                        await fetch(`/admin/user/${userId}`, { method: 'DELETE' });
                        fetchUsers();
                        message.success('User deleted');
                    }
                });
            };

            const handleCreateDeveloper = async (values) => {
                await fetch('/admin/developer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(values)
                });
                fetchDevelopers();
                devForm.resetFields();
                message.success('Developer created');
            };
            
            const handleUpdateDeveloperPoints = async (apiKey, points) => {
                await fetch(`/admin/developer/${apiKey}/points`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ points: parseInt(points) })
                });
                message.success('Points updated');
            };

            const handleDeleteDeveloper = (apiKey) => {
                Modal.confirm({
                    title: 'Are you sure you want to delete this developer?',
                    onOk: async () => {
                        await fetch(`/admin/developer/${apiKey}`, { method: 'DELETE' });
                        fetchDevelopers();
                        message.success('Developer deleted');
                    }
                });
            };

            const userColumns = [
                { title: 'User ID', dataIndex: 'userId', key: 'userId' },
                { title: 'Points', dataIndex: 'points', key: 'points', render: (text, record) => <Input type="number" defaultValue={text} onChange={(e) => handleUpdatePoints(record.userId, e.target.value)} style={{width: '100px'}} /> },
                { title: 'Invited By', dataIndex: 'invitedBy', key: 'invitedBy' },
                { title: 'Actions', key: 'actions', render: (text, record) => <Button danger onClick={() => handleDeleteUser(record.userId)}>Delete</Button> },
            ];

            const developerColumns = [
                { title: 'Name', dataIndex: 'name', key: 'name' },
                { title: 'API Key', dataIndex: 'apiKey', key: 'apiKey' },
                { title: 'Points', dataIndex: 'points', key: 'points', render: (text, record) => <Input type="number" defaultValue={text} onChange={(e) => handleUpdateDeveloperPoints(record.apiKey, e.target.value)} /> },
                { title: 'Actions', key: 'actions', render: (text, record) => <Button danger onClick={() => handleDeleteDeveloper(record.apiKey)}>Delete</Button> },
            ];

            return (
                <div style={{ padding: '50px' }}>
                    <Card title="Admin Dashboard">
                        <a href="/admin/logout">Logout</a>
                        <h2>Users</h2>
                        <Input placeholder="Search users" onChange={handleUserSearch} style={{ marginBottom: '20px' }} />
                        <Table dataSource={filteredUsers} columns={userColumns} rowKey="userId" />

                        <h2>Developers</h2>
                        <Form form={devForm} layout="inline" onFinish={handleCreateDeveloper} style={{ marginBottom: '20px' }}>
                            <Form.Item name="name" rules={[{ required: true }]}>
                                <Input placeholder="Developer Name" />
                            </Form.Item>
                            <Form.Item>
                                <Button type="primary" htmlType="submit">Create Developer</Button>
                            </Form.Item>
                        </Form>
                        <Table dataSource={developers} columns={developerColumns} rowKey="apiKey" />
                    </Card>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
